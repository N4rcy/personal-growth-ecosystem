// Simple AI Analysis
export async function generateAIAnalysis(caseData) {
  console.log("ðŸ” Testing AI for case:", caseData.title);
  
  const apiKey = import.meta.env.VITE_DEEPSEEK_API_KEY;
  const hasRealKey = apiKey && apiKey.startsWith('sk-');
  
  if (!hasRealKey) {
    console.log("âš ï¸ No real API key, using mock data");
    return getMockAnalysis(caseData);
  }
  
  try {
    console.log("ðŸ“¡ Calling DeepSeek API...");
    
    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: 'deepseek-chat',
        messages: [{
          role: 'user',
          content: `Give 3 specific tips for this relationship issue: ${caseData.description}`
        }],
        max_tokens: 300
      })
    });
    
    const data = await response.json();
    console.log("âœ… Got AI response");
    return data.choices[0].message.content;
    
  } catch (error) {
    console.error("âŒ API Error:", error);
    return getMockAnalysis(caseData);
  }
}

// Make mock responses VERY different based on case content
function getMockAnalysis(caseData) {
  const title = caseData.title.toLowerCase();
  const desc = caseData.description.toLowerCase();
  
  console.log("ðŸŽ­ Using mock response for:", title);
  
  if (title.includes('money') || desc.includes('money') || desc.includes('spend')) {
    return `ðŸ’° MONEY ISSUE ANALYSIS:
1. Create a "fun money" budget each gets to spend no questions asked
2. Use cash envelopes for different spending categories
3. Schedule a monthly money date to review finances over coffee`;
  }
  
  else if (title.includes('time') || desc.includes('time') || desc.includes('busy')) {
    return `â° TIME TOGETHER ANALYSIS:
1. Implement "phone-free" hours from 7-9 PM daily
2. Schedule a weekly "adventure hour" trying something new
3. Use a shared calendar to block quality time first`;
  }
  
  else if (title.includes('family') || desc.includes('family') || desc.includes('in-law')) {
    return `ðŸ‘ª FAMILY BOUNDARIES ANALYSIS:
1. Create a "united front" rule - all family feedback gets discussed privately first
2. Set specific visiting hours/days for family
3. Develop code words to signal when boundaries are being crossed`;
  }
  
  else if (title.includes('communicat') || desc.includes('talk') || desc.includes('argu')) {
    return `ðŸ—£ï¸ COMMUNICATION ANALYSIS:
1. Try the "5-minute rule" - each speaks for 5 mins without interruption
2. Use "I feel" statements: "I feel X when Y happens because Z"
3. Schedule weekly "relationship check-ins" on Sundays`;
  }
  
  // Default response that's still specific
  return `ðŸ§  ANALYSIS FOR "${caseData.title}":
1. Identify one small change you can make this week
2. Practice active listening - repeat back what you heard
3. Focus on understanding, not winning the argument`;
}

// Simple formatter
export function formatAnalysisResponse(analysis) {
  // If it's already an object, return it
  if (typeof analysis === 'object') return analysis;
  
  // If it's a string, create a simple object
  return {
    summary: analysis.split('\n')[0] || "Analysis complete",
    rootCause: "Based on your description, this seems to be a common relationship challenge.",
    communicationAdvice: "Focus on listening first, speaking second.",
    nextSteps: ["Try one small change this week", "Check in after 3 days", "Celebrate progress"],
    empathy: "Remember that all relationships go through challenging phases."
  };
}

export const analyzeWithAI = generateAIAnalysis;
EOFcat > src/lib/aiAnalysis.js << 'EOF'
// Simple AI Analysis
export async function generateAIAnalysis(caseData) {
  console.log("ðŸ” Testing AI for case:", caseData.title);
  
  const apiKey = import.meta.env.VITE_DEEPSEEK_API_KEY;
  const hasRealKey = apiKey && apiKey.startsWith('sk-');
  
  if (!hasRealKey) {
    console.log("âš ï¸ No real API key, using mock data");
    return getMockAnalysis(caseData);
  }
  
  try {
    console.log("ðŸ“¡ Calling DeepSeek API...");
    
    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: 'deepseek-chat',
        messages: [{
          role: 'user',
          content: `Give 3 specific tips for this relationship issue: ${caseData.description}`
        }],
        max_tokens: 300
      })
    });
    
    const data = await response.json();
    console.log("âœ… Got AI response");
    return data.choices[0].message.content;
    
  } catch (error) {
    console.error("âŒ API Error:", error);
    return getMockAnalysis(caseData);
  }
}

// Make mock responses VERY different based on case content
function getMockAnalysis(caseData) {
  const title = caseData.title.toLowerCase();
  const desc = caseData.description.toLowerCase();
  
  console.log("ðŸŽ­ Using mock response for:", title);
  
  if (title.includes('money') || desc.includes('money') || desc.includes('spend')) {
    return `ðŸ’° MONEY ISSUE ANALYSIS:
1. Create a "fun money" budget each gets to spend no questions asked
2. Use cash envelopes for different spending categories
3. Schedule a monthly money date to review finances over coffee`;
  }
  
  else if (title.includes('time') || desc.includes('time') || desc.includes('busy')) {
    return `â° TIME TOGETHER ANALYSIS:
1. Implement "phone-free" hours from 7-9 PM daily
2. Schedule a weekly "adventure hour" trying something new
3. Use a shared calendar to block quality time first`;
  }
  
  else if (title.includes('family') || desc.includes('family') || desc.includes('in-law')) {
    return `ðŸ‘ª FAMILY BOUNDARIES ANALYSIS:
1. Create a "united front" rule - all family feedback gets discussed privately first
2. Set specific visiting hours/days for family
3. Develop code words to signal when boundaries are being crossed`;
  }
  
  else if (title.includes('communicat') || desc.includes('talk') || desc.includes('argu')) {
    return `ðŸ—£ï¸ COMMUNICATION ANALYSIS:
1. Try the "5-minute rule" - each speaks for 5 mins without interruption
2. Use "I feel" statements: "I feel X when Y happens because Z"
3. Schedule weekly "relationship check-ins" on Sundays`;
  }
  
  // Default response that's still specific
  return `ðŸ§  ANALYSIS FOR "${caseData.title}":
1. Identify one small change you can make this week
2. Practice active listening - repeat back what you heard
3. Focus on understanding, not winning the argument`;
}

// Simple formatter
export function formatAnalysisResponse(analysis) {
  // If it's already an object, return it
  if (typeof analysis === 'object') return analysis;
  
  // If it's a string, create a simple object
  return {
    summary: analysis.split('\n')[0] || "Analysis complete",
    rootCause: "Based on your description, this seems to be a common relationship challenge.",
    communicationAdvice: "Focus on listening first, speaking second.",
    nextSteps: ["Try one small change this week", "Check in after 3 days", "Celebrate progress"],
    empathy: "Remember that all relationships go through challenging phases."
  };
}

export const analyzeWithAI = generateAIAnalysis;
